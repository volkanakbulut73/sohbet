
-- 1. KAYIT BAŞVURULARI TABLOSU (Kritik: Hatanın çözümü için bu tablo şart)
CREATE TABLE IF NOT EXISTS public.registrations (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    nickname TEXT UNIQUE NOT NULL,
    full_name TEXT NOT NULL, -- Ad Soyad Alanı
    email TEXT UNIQUE NOT NULL,
    password TEXT NOT NULL,
    criminal_record_file TEXT, -- Base64 döküman verisi
    insurance_file TEXT,       -- Base64 döküman verisi
    status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected')),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Eğer tablo zaten varsa şu komutu çalıştırabilirsiniz:
-- ALTER TABLE public.registrations ADD COLUMN IF NOT EXISTS full_name TEXT NOT NULL DEFAULT 'Belirtilmedi';

-- 2. KANALLAR TABLOSU
CREATE TABLE IF NOT EXISTS public.channels (
    name TEXT PRIMARY KEY,
    description TEXT,
    islocked BOOLEAN DEFAULT FALSE,
    ops TEXT[] DEFAULT '{}',
    bannedusers TEXT[] DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Varsayılan kanalları ekle
INSERT INTO public.channels (name, description)
VALUES 
('#sohbet', 'Genel sohbet kanalı'),
('#yardim', 'Destek ve yardım kanalı'),
('#teknoloji', 'Yazılım ve teknoloji odası'),
('#oyun', 'Oyun dünyası')
ON CONFLICT (name) DO NOTHING;

-- 3. MESAJLAR TABLOSU
CREATE TABLE IF NOT EXISTS public.messages (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    sender TEXT NOT NULL,
    text TEXT,
    type TEXT NOT NULL,
    channel TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 4. SİSTEM KONFİGÜRASYON TABLOSU
CREATE TABLE IF NOT EXISTS public.system_config (
    key TEXT PRIMARY KEY,
    value TEXT,
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Varsayılan Admin Ayarları
INSERT INTO public.system_config (key, value)
VALUES 
('bot_instruction', 'Sen Workigom platformu için özelleşmiş bir kurumsal asistansın.'),
('admin_username', 'admin'),
('admin_password', 'admin123')
ON CONFLICT (key) DO NOTHING;

-- 5. GÜVENLİK AYARLARI (RLS)
-- Geliştirme aşamasında kolaylık için RLS'yi devre dışı bırakabilir veya public erişim verebilirsiniz.
ALTER TABLE public.registrations ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public Insert Registrations" ON public.registrations FOR INSERT TO public WITH CHECK (true);
CREATE POLICY "Public Select Registrations" ON public.registrations FOR SELECT TO public USING (true);

ALTER TABLE public.messages ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public All Messages" ON public.messages FOR ALL TO public USING (true) WITH CHECK (true);

ALTER TABLE public.channels ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public Select Channels" ON public.channels FOR SELECT TO public USING (true);
